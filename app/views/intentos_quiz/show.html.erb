<% content_for :title, "Quiz: #{@quiz.titulo}" %>

<div class="container mx-auto px-4 py-6 max-w-7xl"
     data-controller="quiz"
     data-quiz-tiempo-limite-value="<%= @quiz.tiempo_limite %>"
     data-quiz-iniciado-value="<%= @intento.iniciado_en.to_i %>"
     data-quiz-quiz-id-value="<%= @quiz.id %>"
     data-quiz-intento-id-value="<%= @intento.id %>"
     data-quiz-pregunta-actual-value="<%= @current_pregunta&.id %>"
     data-quiz-total-preguntas-value="<%= @preguntas.count %>"
     data-quiz-respondidas-value="<%= @respuestas.keys.count %>"
     data-quiz-auto-save-value="true"
     data-quiz-completado-value="false">

  <!-- Header con título y temporizador -->
  <div class="sticky top-0 z-10 bg-gray-900 border-b border-gray-800 mb-6 -mx-4 px-4 py-3 shadow-md">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
      <h1 class="text-xl font-bold text-white truncate">
        <%= @quiz.titulo %>
      </h1>
      
      <!-- Temporizador -->
      <div class="flex items-center space-x-6">
        <div 
          class="bg-gray-800 p-2 rounded-lg border border-gray-700"
          data-controller="quiz-timer"
          data-quiz-timer-tiempo-limite-value="<%= @quiz.tiempo_limite %>"
          data-quiz-timer-iniciado-en-value="<%= @intento.iniciado_en.to_i %>"
          data-quiz-timer-intento-id-value="<%= @intento.id %>"
          data-quiz-timer-quiz-id-value="<%= @quiz.id %>">
          
          <div class="flex flex-col items-center">
            <div class="flex items-center mb-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
              <span class="text-gray-300 text-sm font-medium">Tiempo Restante:</span>
            </div>
            
            <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden mb-1">
              <div 
                data-quiz-timer-target="progressBar"
                class="bg-green-500 h-full rounded-full transition-all duration-1000"></div>
            </div>
            
            <span 
              data-quiz-timer-target="timeText"
              class="text-xl font-mono font-bold text-white">
              <%= @tiempo_restante / 60 %>:<%= '%02d' % (@tiempo_restante % 60) %>
            </span>
          </div>
        </div>
        
        <!-- Progreso -->
        <div class="bg-gray-800 p-2 rounded-lg border border-gray-700 hidden md:block">
          <div class="flex flex-col items-center">
            <div class="flex items-center mb-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-400 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
              </svg>
              <span class="text-gray-300 text-sm font-medium">Progreso:</span>
            </div>
            
            <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden mb-1">
              <div 
                data-quiz-target="progressBar"
                class="bg-indigo-500 h-full rounded-full transition-all duration-300"
                style="width: <%= @progreso %>%;"></div>
            </div>
            
            <span 
              data-quiz-target="progressText"
              class="text-white font-medium">
              <%= @progreso %>%
            </span>
          </div>
        </div>
        
        <!-- Botón finalizar -->
        <button 
          type="button"
          data-quiz-target="finishButton"
          data-action="quiz#finalizarIntento"
          class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-medium transition-colors duration-200 <%= @todas_respondidas ? '' : 'opacity-75 cursor-not-allowed' %>"
          <%= 'disabled' unless @todas_respondidas %>>
          Finalizar Intento
        </button>
      </div>
    </div>
  </div>

  <!-- Panel flexible con navegación y contenido de pregunta -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Navegación de preguntas - Panel lateral -->
    <div class="lg:col-span-1">
      <div class="sticky top-20">
        <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-hidden shadow-md">
          <div class="p-4 bg-gray-800 flex justify-between items-center">
            <h2 class="font-medium text-white">Navegación</h2>
            <span class="text-gray-400 text-sm">
              <%= @respuestas.keys.count %> / <%= @preguntas.count %> respondidas
            </span>
          </div>
          
          <div class="p-4">
            <!-- Cuadrícula de números de pregunta -->
            <div class="grid grid-cols-5 gap-2 mb-4" data-quiz-target="preguntaNav">
              <% @preguntas.each do |pregunta| %>
                <div class="text-center">
                  <a href="#"
                     data-quiz-target="navItem"
                     data-action="click->quiz#irAPregunta"
                     data-pregunta-id="<%= pregunta.id %>"
                     class="flex items-center justify-center h-9 w-9 rounded-lg <%= @current_pregunta&.id == pregunta.id ? 'bg-indigo-600 text-white' : (@respuestas[pregunta.id] ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-300') %> hover:bg-blue-600 transition-colors <%= @respuestas[pregunta.id] ? 'respondida' : '' %> <%= @current_pregunta&.id == pregunta.id ? 'activa' : '' %>">
                    <%= pregunta.orden %>
                  </a>
                </div>
              <% end %>
            </div>
            
            <!-- Leyenda -->
            <div class="flex flex-col space-y-2 text-sm">
              <div class="flex items-center">
                <span class="inline-block w-4 h-4 bg-gray-700 rounded mr-2"></span>
                <span class="text-gray-400">Sin responder</span>
              </div>
              <div class="flex items-center">
                <span class="inline-block w-4 h-4 bg-green-600 rounded mr-2"></span>
                <span class="text-gray-400">Respondida</span>
              </div>
              <div class="flex items-center">
                <span class="inline-block w-4 h-4 bg-indigo-600 rounded mr-2"></span>
                <span class="text-gray-400">Pregunta actual</span>
              </div>
            </div>
            
            <!-- Información del intento - Mobile Only -->
            <div class="mt-4 md:hidden">
              <div class="bg-gray-800 p-2 rounded-lg border border-gray-700 w-full">
                <div class="flex items-center justify-between">
                  <span class="text-gray-300 text-sm">Progreso:</span>
                  <span class="text-white font-medium"><%= @progreso %>%</span>
                </div>
                <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden my-2">
                  <div 
                    class="bg-indigo-500 h-full rounded-full"
                    style="width: <%= @progreso %>%;"></div>
                </div>
              </div>
            </div>
            
            <!-- Botones de navegación -->
            <div class="flex justify-between mt-6">
              <% if pregunta_anterior = @current_pregunta&.pregunta_anterior %>
                <button 
                  type="button"
                  data-action="click->quiz#irAAnterior"
                  class="flex items-center px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded transition-colors duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                  </svg>
                  Anterior
                </button>
              <% else %>
                <div></div>
              <% end %>
              
              <% if pregunta_siguiente = @current_pregunta&.siguiente_pregunta %>
                <button 
                  type="button"
                  data-action="click->quiz#irASiguiente"
                  class="flex items-center px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded transition-colors duration-200">
                  Siguiente
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </button>
              <% else %>
                <div></div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contenido de la pregunta actual -->
    <div class="lg:col-span-3" data-quiz-target="preguntaContainer">
      <% if @current_pregunta %>
        <%= render partial: 'pregunta', locals: { pregunta: @current_pregunta, respuesta: @respuestas[@current_pregunta.id], intento: @intento } %>
      <% else %>
        <div class="bg-gray-900 rounded-lg border border-gray-700 p-8 text-center">
          <div class="mx-auto w-16 h-16 rounded-full bg-blue-900/30 flex items-center justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-300 mb-2">No se encontró ninguna pregunta</h3>
          <p class="text-gray-500 mb-4">Ha ocurrido un error al cargar la pregunta. Por favor, intenta seleccionar una pregunta de la navegación.</p>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Indicador de guardado automático -->
  <div class="fixed bottom-4 right-4" data-quiz-target="saveIndicator">
    <!-- Este contenedor se actualizará mediante JavaScript -->
  </div>
</div>

<!-- Partial para pregunta individual -->
<% content_for :partial_pregunta do %>
  <script type="text/template" id="template-pregunta">
    <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-hidden shadow-lg">
      <!-- Encabezado de la pregunta -->
      <div class="p-5 border-b border-gray-800 flex justify-between items-center">
        <div class="flex items-center">
          <span class="inline-flex items-center justify-center h-8 w-8 rounded-lg bg-indigo-900 text-indigo-300 border border-indigo-800/50 mr-3 font-medium">
            {{orden}}
          </span>
          <h2 class="text-lg font-medium text-white">{{titulo}}</h2>
        </div>
        <div>
          <span class="px-2 py-1 bg-blue-900/30 text-blue-300 text-xs rounded-lg border border-blue-800/30">
            {{tipo}} - {{puntaje}} puntos
          </span>
        </div>
      </div>
      
      <!-- Contenido de la pregunta -->
      <div class="p-5">
        {{contenido}}
      </div>
      
      <!-- Formulario de respuesta -->
      <div class="p-5 bg-gray-850 border-t border-gray-800">
        {{formulario}}
      </div>
    </div>
  </script>
<% end %>